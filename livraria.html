<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EHB Library - Mural Global</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: sans-serif; background: #f4ecd8; color: #332b22; margin: 0; }
        
        .conteudo-texto, body {
            -webkit-user-select: none; 
            -moz-user-select: none;    
            -ms-user-select: none;     
            user-select: none;
        }

        .screen { display: none; padding: 20px; min-height: 100vh; box-sizing: border-box; }
        body[data-screen="home"] #screen-home { display: block; }
        body[data-screen="editor"] #screen-editor { display: block; }
        body[data-screen="leitura"] #screen-leitura { display: block; }
        body[data-screen="perfil"] #screen-perfil { display: block; }

        .btn-ehb { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; 
                   background: #ff4500; border-radius: 50%; display: flex; 
                   align-items: center; justify-content: center; font-weight: bold; color: white;
                   cursor: pointer; box-shadow: 0 0 15px rgba(255,69,0,0.5); z-index: 100; }
        
        .btn-perfil-float { position: fixed; bottom: 20px; right: 90px; width: 60px; height: 60px; 
                   background: #5d4a37; border-radius: 50%; display: flex; 
                   align-items: center; justify-content: center; font-weight: bold; color: white;
                   cursor: pointer; box-shadow: 0 0 15px rgba(0,0,0,0.2); z-index: 100; font-size: 24px; }

        
        .filtro-container { 
            display: flex; 
            gap: 10px; 
            overflow-x: auto; /* Permite rolar para o lado */
            padding: 10px 5px; 
            margin-bottom: 15px; 
            white-space: nowrap;
            scrollbar-width: none; /* Esconde barra no Firefox */
        }
        .filtro-container::-webkit-scrollbar { display: none; } /* Esconde barra no Chrome/Safari */
        
        .btn-filtro { 
            background: #5d4a37; 
            color: white; 
            padding: 10px 20px; 
            border-radius: 25px; 
            font-size: 14px; 
            border: none; 
            flex-shrink: 0; /* Impede o bot√£o de esmagar */
            font-weight: bold;
            cursor: pointer;
        }

        .btn-filtro:active { background: #ff4500; }

        #lista-obras, #lista-favoritos { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding-top: 10px; }

        .pasta-livro { background: #1f1f1f; color: white; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; border-bottom: 4px solid #ff4500; cursor: pointer; transition: transform 0.2s; }
        .pasta-livro:active { transform: scale(0.95); }
        .capa-estante { width: 100%; height: 150px; object-fit: cover; background: #333; }
        .info-card { padding: 10px; }
        .tag-genero { color: #ff4500; font-size: 10px; font-weight: bold; text-transform: uppercase; }

        input, textarea, select { width: 100%; margin-bottom: 10px; background: #fffcf2; color: #332b22; border: 1px solid #dcd0b9; padding: 12px; box-sizing: border-box; border-radius: 5px; }
        
        
        .btn-publicar-mural { 
            background: #228b22; 
            color: white; 
            border: none; 
            padding: 15px; 
            width: 100%; 
            cursor: pointer; 
            font-weight: bold; 
            border-radius: 8px; 
            margin-bottom: 20px; 
            font-size: 16px;
        }

        button { background: #ff4500; color: white; border: none; padding: 15px; width: 40%; cursor: pointer; font-weight: bold; border-radius: 5px; margin-top: 5px;}
        

        .header-perfil { text-align: center; padding: 30px 20px; background: #2c251e; color: white; border-radius: 15px; margin-bottom: 20px; position: relative; }
        .foto-container { position: relative; width: 100px; height: 100px; margin: 0 auto 15px; }
        #foto-exibida { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 3px solid #ff4500; background: #444; }
        .btn-upload-foto { position: absolute; bottom: 0; right: 0; background: #ff4500; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px solid #2c251e; }
        .stats-perfil { display: flex; justify-content: space-around; margin-top: 15px; border-top: 1px solid #444; padding-top: 15px; }
        .stat-item { text-align: center; font-size: 12px; }
        .stat-item b { display: block; font-size: 16px; color: #ff4500; }





    .nav-bar-container {
    display: flex;
    align-items: center;
    background: #ffffff;
    border: 1px solid #dcd0b9;
    border-radius: 50px;
    padding: 10px 15px;
    margin: 15px 0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
}

.nav-bar-container:active { transform: scale(0.98); }

.nav-text {
    flex: 1;
    font-size: 14px;
    color: #332b22;
    font-family: sans-serif;
    margin-left: 10px;
}

/* Spinner de carregamento para navegador */
.loader {
    width: 18px;
    height: 18px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #ff4500;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    display: none; /* Escondido por padr√£o */
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loading .loader { display: block; }
.loading .nav-icon { display: none; }
        

        .btn-voltar {
    /* Posicionamento */
    display: block;
    margin: 30px auto 0 auto; /* 30px no topo e centralizado horizontalmente */
    
    /* Tamanho e Forma */
    padding: 12px 24px;
    font-size: 16px;
    cursor: pointer;
    border-radius: 8px;
    
    /* Cores: Preto com Dourado */
    background-color: #000000;
    color: #D4AF37; /* Dourado met√°lico */
    border: 2px solid #D4AF37;
    
    /* Tipografia e Efeito */
    font-family: 'Arial', sans-serif;
    font-weight: bold;
    text-transform: uppercase;
    transition: all 0.3s ease;
    box-shadow: 0 0 10px rgba(212, 175, 55, 0.2);
}

/* Efeito ao passar o mouse */
.btn-voltar:hover {
    background-color: #D4AF37;
    color: #000000;
    box-shadow: 0 0 20px rgba(212, 175, 55, 0.6);
}
        


    </style>

    
</head>

    
<body data-screen="home">

    <div class="btn-ehb" onclick="abrirDoacao()">EHB</div>
    <div class="btn-perfil-float" onclick="mudarTela('perfil')">üë§</div>


    <div class="nav-bar-container" id="btnNavegar" onclick="irParaPagina('navegador.html')">
    <span class="nav-icon">üîí</span>
    <div class="loader"></div> <span class="nav-text">multiversy.app/browser</span>
    <span style="color: #ff4500; font-weight: bold;">‚ûú</span>
    </div>
    


    

    <div id="screen-home" class="screen">
        <h2 style="color: #5d4a37; display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 24px;">üìö</span> Multiversy
        </h2>

        <button class="btn-voltar" onclick="window.location.href='index.html'">
    Voltar para o multiversy
        </button>
        
        
        <input type="text" id="campoBusca" placeholder="üîç Pesquisar t√≠tulo ou autor..." onkeyup="filtrarMural()">

        <div class="filtro-container">
            <button class="btn-filtro" onclick="filtrarPorGenero('Todos')">Todos</button>
            <button class="btn-filtro" onclick="filtrarPorGenero('Romance')">‚ù§Ô∏è Romance</button>
            <button class="btn-filtro" onclick="filtrarPorGenero('A√ß√£o')">üí• A√ß√£o</button>
            <button class="btn-filtro" onclick="filtrarPorGenero('Fic√ß√£o Cient√≠fica')">üöÄ Fic√ß√£o</button>
            <button class="btn-filtro" onclick="filtrarPorGenero('Terror')">üëª Terror</button>
            <button class="btn-filtro" onclick="filtrarPorGenero('Mist√©rio')">üîç Mist√©rio</button>
            <button class="btn-filtro" onclick="filtrarPorGenero('Fantasia')">ü¶Ñ Fantasia</button>
            <button class="btn-filtro" onclick="filtrarPorGenero('Dark Romance')">üñ§ Dark Romance</button>
            <button class="btn-filtro" onclick="filtrarPorGenero('Culin√°ria')">üçù Culin√°ria</button>
            <button class="btn-filtro" onclick="filtrarPorGenero('Esportes')">üèüÔ∏è Esportes</button>
        </div>
        
        <button class="btn-publicar-mural" onclick="mudarTela('editor')">‚úçÔ∏è Publicar Nova Obra</button>
        
        <div id="lista-obras"></div>
    </div>

    <div id="screen-perfil" class="screen">
        <button onclick="mudarTela('home')">‚¨Ö Voltar ao Mural</button>
        <div class="header-perfil">
            <div class="foto-container">
                <img id="foto-exibida" src="https://via.placeholder.com/100">
                <label class="btn-upload-foto" for="input-foto">üì∑</label>
                <input type="file" id="input-foto" style="display:none" accept="image/*" onchange="atualizarFotoLocal(this)">
            </div>

            
            <h3 id="perfil-nome" style="margin:0;">Nome do Usu√°rio</h3>
            <p id="perfil-username" style="font-size: 13px; color: #aaa; margin: 5px 0;">@username</p>
            <div id="wallet-display" style="font-size: 11px; color: #ff4500; margin-top: 5px; font-weight: bold;"></div>
            <div class="stats-perfil">
                <div class="stat-item"><b id="stat-favoritos">0</b>FAVORITOS</div>
                <div class="stat-item"><b id="stat-seguindo">0</b>SEGUINDO</div>
            </div>
        </div>
        <h3 style="color: #5d4a37; border-left: 4px solid #ff4500; padding-left: 10px;">‚≠ê Meus Favoritos</h3>
        <div id="lista-favoritos"></div>
    </div>

    <div id="screen-editor" class="screen">
        <button onclick="mudarTela('home')">‚¨Ö Voltar ao Mural</button>
        <h2>Editor de Obra</h2>
        <input type="text" id="titulo" placeholder="T√≠tulo da Obra">
        <input type="text" id="autor" placeholder="Nome do Autor">
        <label style="font-size: 12px; font-weight: bold;">Capa da Obra:</label>
        <input type="file" id="capa" accept="image/*">
        <select id="genero">
            <option value="Romance">‚ù§Ô∏è Romance</option>
            <option value="A√ß√£o">üí• A√ß√£o</option>
            <option value="Fic√ß√£o Cient√≠fica">üöÄ Fic√ß√£o Cient√≠fica</option>
            <option value="Terror">üëª Terror</option>
            <option value="Mist√©rio">üîç Mist√©rio</option>
            <option value="Fantasia">ü¶Ñ Fantasia</option>
            <option value="Dark Romance">üñ§ Dark Romance</option>
        <option value="Culin√°ria">üçù Culin√°ria</option>
            <option value="Esportes">üèüÔ∏è Esportes</option>
        </select>
        <textarea id="sinopse" placeholder="Sinopse"></textarea>
        <textarea id="conteudo" rows="10" placeholder="Escreve o in√≠cio da obra..."></textarea>
        <button id="btnPublicar" onclick="publicarObra()">üöÄ PUBLICAR NO MURAL</button>
    </div>

    <div id="screen-leitura" class="screen">
        <button onclick="mudarTela('home')">‚¨Ö Voltar</button>
        <div id="conteudo-leitura" style="margin-top:20px;"></div>
    </div>

      <script>
 const API = 'https://cristhyno.pythonanywhere.com';
        const tg = window.Telegram.WebApp;
        tg.expand(); 

        let todasAsObras = {}; 

        function mudarTela(tela) {
            document.body.setAttribute('data-screen', tela);
            if(tela === 'home') carregarLivraria();
          if(tela === 'perfil') carregarDadosSociais();
        }

        async function publicarObra() {
            const user = tg.initDataUnsafe.user;
            if(!user) return alert("Por favor, abra o app pelo Telegram!");

            const btn = document.getElementById('btnPublicar');
            btn.innerText = "A processar...";
            btn.disabled = true;

            const formData = new FormData();
            formData.append('titulo', document.getElementById('titulo').value);
            formData.append('autor', document.getElementById('autor').value);
            formData.append('genero', document.getElementById('genero').value);
            formData.append('sinopse', document.getElementById('sinopse').value);
            formData.append('conteudo', document.getElementById('conteudo').value);
            formData.append('usuario_id', user.id); 
            
            const capaInput = document.getElementById('capa');
            if (capaInput.files[0]) formData.append('capa', capaInput.files[0]);

            try {
                const res = await fetch(`${API}/publicar`, { method: 'POST', body: formData });
                if(res.ok) {
                    alert("‚úÖ Obra publicada!");
                    mudarTela('home');
                } else {
                    const erro = await res.json();
                    alert("Erro: " + erro.detalhes);
                }
            } catch (e) { alert("Erro de conex√£o."); }
            finally { btn.innerText = "üöÄ PUBLICAR NO MURAL"; btn.disabled = false; }
        }

        async function carregarLivraria() {
            try {
                const res = await fetch(`${API}/obras`);
                todasAsObras = await res.json();
                renderizarMural(Object.values(todasAsObras));
            } catch(e) { console.log("Erro ao carregar mural."); }
        }

        function renderizarMural(lista) {
            const container = document.getElementById('lista-obras');
            container.innerHTML = '';
            lista.forEach(obra => {
                const card = document.createElement('div');
                card.className = 'pasta-livro';
                card.onclick = () => verObra(obra);

                
                card.innerHTML = `
                    <img src="${obra.capa_url || 'https://via.placeholder.com/150x200'}" class="capa-estante">
                    <div class="info-card">

                    
                        <span class="tag-genero">${obra.genero}</span>
                        <div style="font-weight: bold; margin-top: 5px;">${obra.titulo}</div>
                        <div style="font-size: 11px; color: #bbb;">Por: ${obra.autor}</div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function filtrarMural() {
    const termo = document.getElementById('campoBusca').value.toLowerCase();
    const filtradas = Object.values(todasAsObras).filter(o => 
        o.titulo.toLowerCase().includes(termo) || o.autor.toLowerCase().includes(termo)
    );
    renderizarMural(filtradas);
        }
          


          function filtrarPorGenero(genero) {
    if(genero === 'Todos') {
        renderizarMural(Object.values(todasAsObras), 'lista-obras'); // O segundo termo √© a chave!
    } else {
        const filtradas = Object.values(todasAsObras).filter(o => o.genero === genero);
        renderizarMural(filtradas,'lista-obras'); 
    }
          }
          

        function verObra(obra) {
            mudarTela('leitura');
            const user = tg.initDataUnsafe.user;
            const currentUserId = user ? user.id.toString() : null;
            
            const tituloRef = obra.titulo;
            const obraID_excluir = obra.titulo.replace(/ /g, "_").toLowerCase();

            let painelEscritorHTML = "";
            
            // TRAVA CORRIGIDA: Permite se n√£o houver dono eu pego, se tiver  dono eu n√£o pego. admin
            if (!obra.usuario_id || currentUserId === obra.usuario_id.toString() || currentUserId === "7343419996") {
                painelEscritorHTML = `
                    <div class="painel-escritor">
                        <h4 style="margin-top:0;">üõ†Ô∏è Painel do Escritor</h4>
                        <textarea id="texto-nova-pagina" placeholder="Escreve a nova p√°gina aqui..." style="height: 100px; width:100%;"></textarea>
                        <button onclick="acrescentarPagina('${tituloRef}')" style="background: #228b22;">‚ûï ADICIONAR ESTA P√ÅGINA</button>
                        <button class="btn-excluir" onclick="excluirObra('${obraID_excluir}')">üóëÔ∏è EXCLUIR OBRA</button>
                    </div>
                `;
            }

            document.getElementById('conteudo-leitura').innerHTML = `
                <img src="${obra.capa_url || 'https://via.placeholder.com/150x200'}" style="width:100%; border-radius:10px; border: 2px solid #ff4500;">
                <h2>${obra.titulo}</h2>
                <p><strong>Autor:</strong> ${obra.autor}</p>
                <p style="background: #e9dcc3; padding: 10px; border-radius: 5px;"><em>${obra.sinopse}</em></p>
                
                <button onclick="window.open('${obra.telegram_link}', '_blank')">üí¨ LER NO TELEGRAM</button>

<button onclick="favoritarESeguir('${obra.titulo}', '${obra.usuario_id}')" style="background: #ff4500; flex: 1;">üîñ LER DEPOIS</button>
                
                ${painelEscritorHTML}

                <hr style="margin: 20px 0;">
                <div class="conteudo-texto" style="padding: 15px; background: #fffcf2; border-radius: 5px; border: 1px solid #dcd0b9;">
                    ${obra.conteudo.replace(/\n/g, '<br>')}
                </div>
            `;
        }

        async function acrescentarPagina(titulo) {
            const user = tg.initDataUnsafe.user;
            const texto = document.getElementById('texto-nova-pagina').value;
            if(!texto) return alert("Escreve algo!");

            const fd = new FormData();
            fd.append('titulo', titulo);
            fd.append('conteudo', texto);
            fd.append('usuario_id', user.id); 

            try {
                const res = await fetch(`${API}/publicar`, { method: 'POST', body: fd });
                if(res.ok) { alert("üìÑ P√°gina adicionada!"); mudarTela('home'); }
                else { alert("Apenas o autor pode editar esta obra."); }
            } catch (e) { alert("Erro ao adicionar."); }
        }

        async function excluirObra(obra_id) {
            const user = tg.initDataUnsafe.user;
            if(!confirm("Excluir do Mural e Telegram?")) return;

            try {
                const res = await fetch(`${API}/excluir`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        obra_id: obra_id,
                        usuario_id: user.id 
                    })
                });
                if(res.ok) { alert("Removida."); mudarTela('home'); }
                else { alert("Voc√™ n√£o tem permiss√£o para excluir esta obra."); }
            } catch (e) { alert("Erro ao excluir."); }
        }

function obterSocial() {
            const d = localStorage.getItem('ehb_social_data');
            return d ? JSON.parse(d) : { favoritos: [], seguindo: [], foto: "" };
        }

        function salvarSocial(d) {
            localStorage.setItem('ehb_social_data', JSON.stringify(d));
        }

        function carregarDadosSociais() {
            const user = tg.initDataUnsafe.user || { first_name: "Visitante", username: "user" };
            const social = obterSocial();
            document.getElementById('perfil-nome').innerText = user.first_name;
            document.getElementById('perfil-username').innerText = "@" + (user.username || "anon");
            document.getElementById('stat-favoritos').innerText = social.favoritos.length;
            document.getElementById('stat-seguindo').innerText = social.seguindo.length;
            if(social.foto) document.getElementById('foto-exibida').src = social.foto;
            const favs = Object.values(todasAsObras).filter(o => social.favoritos.includes(o.titulo));
            renderizarMural(favs, 'lista-favoritos');
        }

        function atualizarFotoLocal(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const social = obterSocial();
                    social.foto = e.target.result;
                    salvarSocial(social);
                    document.getElementById('foto-exibida').src = social.foto;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function favoritarESeguir(titulo, autorId) {
            let social = obterSocial();
            if(!social.favoritos.includes(titulo)) social.favoritos.push(titulo);
            if(autorId && !social.seguindo.includes(autorId.toString())) {
                social.seguindo.push(autorId.toString());
            }
            salvarSocial(social);
            alert("üîñ Salvo nos favoritos!");
        }
async function carregarLivraria() {
            try {
                const res = await fetch(`${API}/obras`);
                todasAsObras = await res.json();
                renderizarMural(Object.values(todasAsObras), 'lista-obras');
            } catch(e) { console.log("Erro ao carregar."); }
        }

        function renderizarMural(lista, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            lista.forEach(obra => {
                const card = document.createElement('div');
                card.className = 'pasta-livro';
                card.onclick = () => verObra(obra);
                card.innerHTML = `
                    <img src="${obra.capa_url || 'https://via.placeholder.com/150x200'}" class="capa-estante">
                    <div class="info-card">
                        <span class="tag-genero">${obra.genero}</span>
                        <div style="font-weight: bold; margin-top: 5px;">${obra.titulo}</div>
                        <div style="font-size: 11px; color: #bbb;">Por: ${obra.autor}</div>
                    </div>`;
                container.appendChild(card);
            });
        }



        function abrirDoacao() { alert("EHB Library - Apoie o crescimento para os escritores, fa√ßa sua doa√ß√£o para melhorar o desenvolvimento do ecossistema. Chave pix: lusther3dmult@gmail.com ou envie cripto para o endere√ßo de wallet: 0x2ea5d9c734ac06d639d3e4b70ae4c1e163b48555 rede Polygon !"); }
        window.onload = () => { mudarTela('home'); };


          function irParaPagina(arquivoHtml) {
    const btn = document.getElementById('btnNavegar');
    
    // 1. Ativa a anima√ß√£o de carregamento de pesquisa
              
    btn.classList.add('loading');
    
    // 2. Pequeno delay para o utilizador ver o feedback visual
              
    setTimeout(() => {

         // 3. Redireciona para o outro arquivo HTML que √© a pagina de acrescimo
        
        window.location.href = arquivoHtml;
    }, 800); 
          }
          
   
                                                
            
    </script>
</body>
</html>
