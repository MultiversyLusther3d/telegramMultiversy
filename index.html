<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EHB Library - Mural Global</title>
    <style>
        /* Estilos e Bloqueio de Seguran√ßa [cite: 2026-01-17] */
        body { font-family: sans-serif; background: #f4ecd8; color: #332b22; margin: 0; }
        
        .conteudo-texto, body {
            -webkit-user-select: none; 
            -moz-user-select: none;    
            -ms-user-select: none;     
            user-select: none;
        }

        .screen { display: none; padding: 20px; min-height: 100vh; box-sizing: border-box; }
        body[data-screen="home"] #screen-home { display: block; }
        body[data-screen="editor"] #screen-editor { display: block; }
        body[data-screen="leitura"] #screen-leitura { display: block; }

        .btn-ehb { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; 
                   background: #ff4500; border-radius: 50%; display: flex; 
                   align-items: center; justify-content: center; font-weight: bold; color: white;
                   cursor: pointer; box-shadow: 0 0 15px rgba(255,69,0,0.5); z-index: 100; }

        /* ESTANTE GLOBAL EM GRADE */
        #lista-obras {
            display: grid;
            grid-template-columns: 1fr 1fr; 
            gap: 15px;
            padding-top: 10px;
        }

        .pasta-livro { 
            background: #1f1f1f; 
            color: white; 
            border-radius: 8px; 
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border-bottom: 4px solid #ff4500;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .pasta-livro:active { transform: scale(0.95); }

        .capa-estante {
            width: 100%;
            height: 150px;
            object-fit: cover;
            background: #333;
        }

        .info-card { padding: 10px; }
        .tag-genero { color: #ff4500; font-size: 10px; font-weight: bold; text-transform: uppercase; }

        input, textarea, select { width: 100%; margin-bottom: 10px; background: #fffcf2; color: #332b22; border: 1px solid #dcd0b9; padding: 10px; box-sizing: border-box; }
        button { background: #ff4500; color: white; border: none; padding: 15px; width: 100%; cursor: pointer; font-weight: bold; border-radius: 5px; margin-top: 5px;}
        
        .btn-excluir { background: #b22222 !important; margin-top: 10px; }
    </style>
</head>
<body data-screen="home">

    <div class="btn-ehb" onclick="abrirDoacao()">EHB</div>

    <div id="screen-home" class="screen">
        <h2 style="color: #5d4a37;">üìö Mural de Obras EHB</h2>
        <button onclick="mudarTela('editor')" style="margin-bottom: 20px; background: #228b22;">‚úçÔ∏è Publicar Nova Obra</button>
        <div id="lista-obras">
            </div>
    </div>

    <div id="screen-editor" class="screen">
        <button onclick="mudarTela('home')">‚¨Ö Voltar ao Mural</button>
        <h2 id="titulo-editor">Editor de Obra</h2>
        <p style="font-size: 11px; color: #8b4513;">*Use o mesmo t√≠tulo para acrescentar p√°ginas ao t√≥pico.</p>
        
        <input type="text" id="titulo" placeholder="T√≠tulo da Obra">
        <input type="text" id="autor" placeholder="Nome do Autor">
        
        <label style="font-size: 12px; font-weight: bold;">Capa da Obra:</label>
        <input type="file" id="capa" accept="image/*">
        
        <select id="genero">
            <option value="Romance">‚ù§Ô∏è Romance</option>
            <option value="A√ß√£o">üí• A√ß√£o</option>
            <option value="Fic√ß√£o Cient√≠fica">üöÄ Fic√ß√£o Cient√≠fica</option>
            <option value="Terror">üëª Terror</option>
            <option value="Quadrinhos">üé® Quadrinhos</option>
            <option value="Mist√©rio">üîç Mist√©rio</option>
        </select>

        <textarea id="sinopse" placeholder="Sinopse (Aparece no Telegram)"></textarea>
        <textarea id="conteudo" rows="10" placeholder="Escreva aqui sua hist√≥ria ou nova p√°gina..."></textarea>
        
        <button id="btnPublicar" onclick="publicarObra()">üöÄ ENVIAR AO MURAL E TELEGRAM</button>
    </div>

    <div id="screen-leitura" class="screen">
        <button onclick="mudarTela('home')">‚¨Ö Voltar</button>
        <div id="conteudo-leitura" style="margin-top:20px;"></div>
    </div>

    <script>
        const API = 'https://cristhyno.pythonanywhere.com';

        function mudarTela(tela) {
            document.body.setAttribute('data-screen', tela);
            if(tela === 'home') carregarLivraria();
        }

        async function publicarObra() {
            const btn = document.getElementById('btnPublicar');
            btn.innerText = "A processar envio...";
            btn.disabled = true;

            const formData = new FormData();
            formData.append('titulo', document.getElementById('titulo').value);
            formData.append('autor', document.getElementById('autor').value);
            formData.append('genero', document.getElementById('genero').value);
            formData.append('sinopse', document.getElementById('sinopse').value);
            formData.append('conteudo', document.getElementById('conteudo').value);
            
            const capaInput = document.getElementById('capa');
            if (capaInput.files[0]) {
                formData.append('capa', capaInput.files[0]);
            }

            try {
                const res = await fetch(`${API}/publicar`, {
                    method: 'POST',
                    body: formData 
                });
                if(res.ok) {
                    alert("‚úÖ Sucesso! Obra atualizada no Mural e no T√≥pico.");
                    mudarTela('home');
                }
            } catch (e) {
                alert("‚ùå Erro de conex√£o com o servidor.");
            } finally {
                btn.innerText = "üöÄ ENVIAR AO MURAL E TELEGRAM";
                btn.disabled = false;
            }
        }

        async function carregarLivraria() {
            try {
                const res = await fetch(`${API}/obras`);
                const obras = await res.json();
                const container = document.getElementById('lista-obras');
                container.innerHTML = '';

                Object.values(obras).forEach(obra => {
                    const card = document.createElement('div');
                    card.className = 'pasta-livro';
                    card.onclick = () => verObra(obra);
                    
                    card.innerHTML = `
                        <img src="${obra.capa_url || 'https://via.placeholder.com/150x200'}" class="capa-estante">
                        <div class="info-card">
                            <span class="tag-genero">${obra.genero}</span>
                            <div style="font-weight: bold; margin-top: 5px; color: #fff;">${obra.titulo}</div>
                            <div style="font-size: 11px; color: #bbb;">Por: ${obra.autor}</div>
                        </div>
                    `;
                    container.appendChild(card);
                });
            } catch(e) { 
                console.log("Erro ao carregar o mural global."); 
            }
        }

        function verObra(obra) {
    mudarTela('leitura');
    const obraID = obra.titulo.replace(/ /g, "_").toLowerCase();
    
    // Criamos o HTML da obra
    let htmlLeitura = `
        <img src="${obra.capa_url || 'https://via.placeholder.com/150x200'}" style="width:100%; border-radius:10px; border: 2px solid #ff4500;">
        <h2 style="margin-bottom: 5px;">${obra.titulo}</h2>
        <p><strong>Autor:</strong> ${obra.autor} | <strong>G√™nero:</strong> ${obra.genero}</p>
        <p style="background: #e9dcc3; padding: 10px; border-radius: 5px;"><em>${obra.sinopse}</em></p>
        
        <button onclick="window.open('${obra.telegram_link}', '_blank')">üí¨ LER NO T√ìPICO DO TELEGRAM</button>
        
        <div style="margin-top: 20px; padding: 15px; border: 2px dashed #ff4500; border-radius: 10px; background: #fff5e6;">
            <h4 style="margin-top:0;">üõ†Ô∏è Painel do Escritor</h4>
            <textarea id="texto-nova-pagina" placeholder="Escreva a nova p√°gina aqui..." style="height: 100px;"></textarea>
            <button onclick="acrescentarPagina('${obraID}')" style="background: #228b22;">‚ûï ADICIONAR ESTA P√ÅGINA</button>
            <button class="btn-excluir" onclick="excluirObra('${obraID}')">üóëÔ∏è EXCLUIR TODA A OBRA</button>
        </div>

        <hr style="margin: 20px 0;">
        <div class="conteudo-texto" style="padding: 15px; background: #fffcf2; border-radius: 5px; line-height: 1.6; border: 1px solid #dcd0b9;">
            ${obra.conteudo.replace(/\n/g, '<br>')}
        </div>
    `;
    
    document.getElementById('conteudo-leitura').innerHTML = htmlLeitura;
}

// NOVA FUN√á√ÉO: Envia apenas a nova p√°gina para o t√≥pico existente
async function acrescentarPagina(obra_id) {
    const conteudo = document.getElementById('texto-nova-pagina').value;
    if(!conteudo) return alert("Escreva algo primeiro!");

    const formData = new FormData();
    formData.append('titulo', obra_id.replace(/_/g, " ")); // Reconecta pelo t√≠tulo
    formData.append('conteudo', conteudo);

    try {
        const res = await fetch(`${API}/publicar`, {
            method: 'POST',
            body: formData 
        });
        if(res.ok) {
            alert("üìÑ P√°gina adicionada com sucesso ao t√≥pico!");
            carregarLivraria(); // Atualiza os dados
            mudarTela('home'); // Volta para o mural
        }
    } catch (e) {
        alert("Erro ao conectar.");
    }
}
        

        async function excluirObra(obra_id) {
            if(!confirm("Tem certeza? Isso remover√° a obra do Mural e excluir√° o t√≥pico no Telegram.")) return;
            
            try {
                const res = await fetch(`${API}/excluir`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ obra_id: obra_id })
                });
                if(res.ok) {
                    alert("Obra removida com sucesso.");
                    mudarTela('home');
                }
            } catch (e) {
                alert("Erro ao tentar excluir.");
            }
        }

        function abrirDoacao() { alert("EHB Library - Apoie a cultura livre!"); }

        window.onload = () => { mudarTela('home'); };

        // Prote√ß√µes [cite: 2026-01-17]
        document.addEventListener('contextmenu', e => e.preventDefault());
        document.addEventListener('keydown', e => {
            if (e.ctrlKey && (e.key === 'c' || e.key === 'u' || e.key === 's')) e.preventDefault();
        });
    </script>
</body>
</html>
